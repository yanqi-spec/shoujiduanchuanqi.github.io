<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>勇者传说</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#0d1b2a;
      color:white;
      font-family:Arial,sans-serif;
      overflow:hidden;
      touch-action:none;
      -webkit-tap-highlight-color:transparent;
    }
    #gameCanvas {
      display:block;
      width:100vw;
      height:100vh;
      max-width:640px;
      max-height:480px;
      margin:auto;
    }
    #ui {
      position:absolute;
      top:10px;
      left:10px;
      background:rgba(0,0,0,0.5);
      padding:6px 10px;
      border-radius:6px;
      font-size:14px;
      z-index:10;
    }
    #stageNum {
      cursor:pointer;
      color:#4fc3f7;
    }
    .btn {
      position:absolute;
      width:60px;
      height:60px;
      border-radius:50%;
      background:rgba(30,50,80,0.8);
      border:2px solid #4fc3f7;
      color:white;
      font-weight:bold;
      display:flex;
      justify-content:center;
      align-items:center;
      user-select:none;
      z-index:10;
    }
    #joystick {
      position:absolute;
      bottom:20px;
      left:20px;
      width:100px;
      height:100px;
      border-radius:50%;
      background:rgba(100,150,255,0.2);
    }
    #knob {
      position:absolute;
      width:40px;
      height:40px;
      border-radius:50%;
      background:#4fc3f7;
      top:30px;
      left:30px;
      box-shadow:0 0 8px rgba(79,195,247,0.8);
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="640" height="480"></canvas>
  <div id="ui">
    ❤️ <span id="hp">100</span> | ⚔️ <span id="atk">5</span> | 关卡: <span id="stageNum">1</span>
  </div>

  <!-- Mobile Controls -->
  <div id="joystick"><div id="knob"></div></div>
  <div class="btn" id="attackBtn" style="bottom:20px; right:20px;">⚔️</div>
  <div class="btn" id="qBtn" style="bottom:90px; right:20px;">Q</div>
  <div class="btn" id="eBtn" style="bottom:90px; right:90px;">E</div>
  <div class="btn" id="rBtn" style="bottom:20px; right:90px;">R</div>

  <script>
    // ===== 全局配置 =====
    const CANVAS_WIDTH = 640;
    const CANVAS_HEIGHT = 480;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let enemies = [];
    let currentStage = 0;
    let gameOver = false;
    let godMode = false;
    let stageClickCount = 0;
    let bossSummonTimer = 0;

    // 输入状态
    let keys = {};
    let joystickActive = false;
    let joyX = 0, joyY = 0;

    // 玩家
    const player = {
      x: 100, y: 240, size: 24,
      hp: 100, maxHp: 100,
      speed: 3, atk: 5,
      attackCd: 0, flash: 0
    };

    // ===== 无敌模式：点关卡4次 =====
    document.getElementById('stageNum').addEventListener('click', () => {
      if (gameOver) return;
      stageClickCount++;
      setTimeout(() => stageClickCount = 0, 500);
      if (stageClickCount >= 4) {
        godMode = !godMode;
        if (godMode) {
          player.hp = player.maxHp = 9999;
          player.atk = 9999;
        } else {
          player.hp = player.maxHp = 100;
          player.atk = 5;
        }
        updateUI();
        alert(godMode ? "无敌开启！" : "无敌关闭");
      }
    });

    // ===== 摇杆初始化 =====
    const joystick = document.getElementById('joystick');
    const knob = document.getElementById('knob');
    const joyRadius = 50;
    let joyCenterX = 0, joyCenterY = 0;

    function setupJoystick() {
      const rect = joystick.getBoundingClientRect();
      joyCenterX = rect.left + joyRadius;
      joyCenterY = rect.top + joyRadius;
    }

    function handleTouch(e, isStart) {
      e.preventDefault();
      const touch = e.touches[0] || e;
      const dx = touch.clientX - joyCenterX;
      const dy = touch.clientY - joyCenterY;
      const dist = Math.hypot(dx, dy);
      
      if (isStart && dist <= joyRadius) {
        joystickActive = true;
      }
      
      if (joystickActive) {
        if (dist > joyRadius) {
          joyX = (dx / dist) * joyRadius;
          joyY = (dy / dist) * joyRadius;
        } else {
          joyX = dx;
          joyY = dy;
        }
        knob.style.transform = `translate(${joyX}px, ${joyY}px)`;
      }
      
      if (!isStart) {
        joystickActive = false;
        joyX = joyY = 0;
        knob.style.transform = 'translate(0,0)';
      }
    }

    joystick.addEventListener('touchstart', e => { setupJoystick(); handleTouch(e, true); });
    window.addEventListener('touchmove', e => handleTouch(e, false));
    window.addEventListener('touchend', e => handleTouch(e, false));

    // 兼容 PC 鼠标（调试用）
    joystick.addEventListener('mousedown', e => { setupJoystick(); handleTouch(e, true); });
    window.addEventListener('mousemove', e => handleTouch(e, false));
    window.addEventListener('mouseup', e => handleTouch(e, false));

    // ===== 按钮绑定 =====
    document.getElementById('attackBtn').addEventListener('touchstart', attack);
    document.getElementById('qBtn').addEventListener('touchstart', () => useSkill('q'));
    document.getElementById('eBtn').addEventListener('touchstart', () => useSkill('e'));
    document.getElementById('rBtn').addEventListener('touchstart', () => useSkill('r'));

    // 兼容 PC 点击
    document.getElementById('attackBtn').addEventListener('mousedown', attack);
    document.getElementById('qBtn').addEventListener('mousedown', () => useSkill('q'));
    document.getElementById('eBtn').addEventListener('mousedown', () => useSkill('e'));
    document.getElementById('rBtn').addEventListener('mousedown', () => useSkill('r'));

    function attack() {
      if (player.attackCd <= 0 && !gameOver) {
        player.attackCd = 20;
        player.flash = 5;
        // 简单攻击逻辑
        for (let i = enemies.length - 1; i >= 0; i--) {
          const e = enemies[i];
          const dist = Math.hypot(
            (player.x + 12) - (e.x + 10),
            (player.y + 12) - (e.y + 10)
          );
          if (dist < 80) {
            e.hp -= player.atk;
            if (e.hp <= 0) enemies.splice(i, 1);
          }
        }
        checkWin();
      }
    }

    function useSkill(key) {
      if (gameOver) return;
      alert(`释放技能: ${key.toUpperCase()}`);
    }

    function checkWin() {
      if (enemies.length === 0) {
        currentStage++;
        startStage(currentStage);
      }
    }

    function startStage(stage) {
      enemies = [];
      player.x = 100; player.y = 240;
      const count = 3 + Math.min(stage, 10);
      for (let i = 0; i < count; i++) {
        enemies.push({
          x: 500 + Math.random() * 100,
          y: 100 + Math.random() * 300,
          hp: 30 + stage * 5,
          size: 20
        });
      }
      document.getElementById('stageNum').textContent = stage + 1;
      updateUI();
    }

    function updateUI() {
      document.getElementById('hp').textContent = player.hp;
      document.getElementById('atk').textContent = player.atk;
    }

    // ===== 主循环 =====
    function update() {
      if (gameOver) return;

      // 移动
      let dx = 0, dy = 0;
      if (keys['a'] || keys['ArrowLeft']) dx -= player.speed;
      if (keys['d'] || keys['ArrowRight']) dx += player.speed;
      if (keys['w'] || keys['ArrowUp']) dy -= player.speed;
      if (keys['s'] || keys['ArrowDown']) dy += player.speed;
      if (joystickActive) {
        dx += (joyX / joyRadius) * player.speed;
        dy += (joyY / joyRadius) * player.speed;
      }

      player.x = Math.max(0, Math.min(CANVAS_WIDTH - player.size, player.x + dx));
      player.y = Math.max(0, Math.min(CANVAS_HEIGHT - player.size, player.y + dy));

      if (player.attackCd > 0) player.attackCd--;
      if (player.flash > 0) player.flash--;

      // 敌人 AI（简单向玩家移动）
      enemies.forEach(e => {
        const px = player.x + 12, py = player.y + 12;
        const ex = e.x + 10, ey = e.y + 10;
        const angle = Math.atan2(py - ey, px - ex);
        e.x += Math.cos(angle) * 1;
        e.y += Math.sin(angle) * 1;
        if (Math.hypot(px - ex, py - ey) < 20) {
          player.hp -= 1;
          if (player.hp <= 0) {
            player.hp = 0;
            gameOver = true;
            alert("游戏结束！刷新重试");
          }
          updateUI();
        }
      });
    }

    function render() {
      ctx.fillStyle = '#0d1b2a';
      ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

      // 玩家
      ctx.fillStyle = player.flash > 0 ? '#aaffaa' : '#4caf50';
      ctx.fillRect(player.x, player.y, player.size, player.size);

      // 敌人
      enemies.forEach(e => {
        ctx.fillStyle = '#f44336';
        ctx.fillRect(e.x, e.y, e.size, e.size);
      });
    }

    function gameLoop() {
      update();
      render();
      requestAnimationFrame(gameLoop);
    }

    // 键盘支持（PC）
    window.addEventListener('keydown', e => keys[e.key] = true);
    window.addEventListener('keyup', e => keys[e.key] = false);

    // 启动
    startStage(0);
    gameLoop();
  </script>
</body>
</html>