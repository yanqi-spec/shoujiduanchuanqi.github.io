<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>✨ 连连看 - 5关挑战（难度递增）</title>
  <style>
    body {
      background: #f5f7fa;
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      color: #333;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 10px;
      font-weight: 600;
    }
    #game-container {
      position: relative;
      display: inline-block;
      margin-top: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      border-radius: 8px;
      overflow: hidden;
    }
    #game-board {
      display: grid;
      background: transparent;
      padding: 0;
      border: none;
    }
    .cell {
      background: white;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .cell.selected {
      box-shadow: 0 0 0 3px gold;
    }
    .cell img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .cell.removing {
      animation: removeAnim 0.5s forwards;
    }
    @keyframes removeAnim {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(0); opacity: 0; }
    }

    #score {
      font-size: 22px;
      color: #e74c3c;
      margin: 10px;
      font-weight: bold;
    }
    #level-info {
      font-size: 18px;
      color: #2980b9;
      margin-bottom: 8px;
    }
    .buttons-area {
      margin-top: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 8px;
      transition: all 0.2s;
      font-weight: 600;
    }
    #restart-btn {
      background: #3498db;
      color: white;
    }
    #reshuffle-btn {
      background: #9b59b6;
      color: white;
    }
    #restart-btn:hover:not(:disabled),
    #reshuffle-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    #reshuffle-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* 精美弹窗 */
    .popup {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
      from { opacity: 0; } to { opacity: 1; }
    }
    .popup-content {
      background: white;
      padding: 35px 45px;
      border-radius: 16px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      max-width: 420px;
      text-align: center;
      position: relative;
      transform: scale(0.95);
      animation: popIn 0.4s forwards;
    }
    @keyframes popIn {
      to { transform: scale(1); }
    }
    .close-btn {
      position: absolute;
      top: 14px;
      right: 18px;
      font-size: 26px;
      color: #aaa;
      cursor: pointer;
      font-weight: normal;
      transition: color 0.2s;
    }
    .close-btn:hover {
      color: #333;
    }
    #popup-message {
      font-size: 19px;
      line-height: 1.6;
      color: #333;
      font-weight: 500;
    }
    .popup-icon {
      font-size: 48px;
      margin-bottom: 15px;
      display: block;
    }

    #path-canvas {
      position: absolute;
      top: -20px;
      left: -20px;
      pointer-events: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h2>✨ 连连看 - 5关挑战（难度递增）</h2>
  <div id="level-info">第 <span id="current-level">1</span> 关 / 共 5 关</div>
  <div id="score">剩余图块: 64</div>
  <div id="game-container">
    <div id="game-board"></div>
    <canvas id="path-canvas"></canvas>
  </div>

  <div class="buttons-area">
    <button id="restart-btn" onclick="initGame()">🔄 重新开始</button>
    <button id="reshuffle-btn" onclick="reshuffleBoard()">🔀 重洗牌（<span id="reshuffle-count">2</span> 次）</button>
  </div>

  <!-- 精美弹窗 -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup()">&times;</span>
      <span id="popup-icon" class="popup-icon"></span>
      <p id="popup-message"></p>
    </div>
  </div>

  <script>
    // 提供 20 张不同的图片（确保第5关有足够种类）
    const images = [
      "https://pic1.imgdb.cn/item/693a66060edaae20ec55fdaa.jpg",
      "https://pic1.imgdb.cn/item/693a66060edaae20ec55fdaf.jpg",
      "https://pic1.imgdb.cn/item/693a66060edaae20ec55fdac.jpg",
      "https://pic1.imgdb.cn/item/693a66060edaae20ec55fdab.jpg",
      "https://pic1.imgdb.cn/item/693a66060edaae20ec55fdae.jpg",
      "https://pic1.imgdb.cn/item/693a66170edaae20ec55fe3f.jpg",
      "https://pic1.imgdb.cn/item/693a66170edaae20ec55fe41.png",
      "https://pic1.imgdb.cn/item/693a66170edaae20ec55fe40.jpg",
      "https://pic1.imgdb.cn/item/693a66170edaae20ec55fe3c.jpg",
      "https://pic1.imgdb.cn/item/693a66170edaae20ec55fe3d.jpg",
      "https://pic1.imgdb.cn/item/693a66230edaae20ec55feaf.png",
      "https://pic1.imgdb.cn/item/693a66220edaae20ec55feaa.jpg",
      "https://pic1.imgdb.cn/item/693a66230edaae20ec55feae.jpg",
      "https://pic1.imgdb.cn/item/693a66230edaae20ec55feb2.png",
      "https://pic1.imgdb.cn/item/693a66230edaae20ec55feab.png",
      "https://pic1.imgdb.cn/item/693a66240edaae20ec55ff01.jpg",
      "https://pic1.imgdb.cn/item/693a66240edaae20ec55ff02.png",
      "https://pic1.imgdb.cn/item/693a66240edaae20ec55ff03.jpg",
      "https://pic1.imgdb.cn/item/693a66240edaae20ec55ff04.png",
      "https://pic1.imgdb.cn/item/693a66240edaae20ec55ff05.jpg"
    ];

    // 关卡配置：[rows, cols, numTypes]
    const LEVEL_CONFIG = [
      [8, 8, 4],   // Level 1
      [10, 10, 8], // Level 2
      [10, 12, 12],// Level 3
      [12, 12, 16],// Level 4
      [12, 12, 20] // Level 5
    ];

    let board = [];
    let firstSelected = null;
    let totalTiles = 0;
    let currentLevel = 1;
    let reshuffleCount = 2;
    let ROWS, COLS, CELL_SIZE = 50;

    function buildExtendedBoard() {
      const extRows = ROWS + 2;
      const extCols = COLS + 2;
      const ext = Array(extRows).fill().map(() => Array(extCols).fill(-1));
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          ext[r + 1][c + 1] = board[r][c];
        }
      }
      return ext;
    }

    function findPathBFS(r1, c1, r2, c2) {
      const ext = buildExtendedBoard();
      const startR = r1 + 1, startC = c1 + 1;
      const endR = r2 + 1, endC = c2 + 1;

      if (ext[startR][startC] === -1 || ext[endR][endC] === -1) return null;
      if (ext[startR][startC] !== ext[endR][endC]) return null;

      const queue = [{ r: startR, c: startC }];
      const parent = {};
      const key = (r, c) => `${r},${c}`;
      const visited = new Set();
      visited.add(key(startR, startC));

      const dirs = [[0,1], [1,0], [0,-1], [-1,0]];

      while (queue.length > 0) {
        const { r, c } = queue.shift();

        if (r === endR && c === endC) {
          const pathExt = [];
          let cur = key(r, c);
          while (cur !== key(startR, startC)) {
            const [cr, cc] = cur.split(',').map(Number);
            pathExt.push({ r: cr - 1, c: cc - 1 });
            cur = parent[cur];
          }
          pathExt.push({ r: r1, c: c1 });
          return pathExt.reverse();
        }

        for (const [dr, dc] of dirs) {
          const nr = r + dr;
          const nc = c + dc;

          if (nr < 0 || nr >= ROWS + 2 || nc < 0 || nc >= COLS + 2) continue;
          if (visited.has(key(nr, nc))) continue;
          if (!(nr === endR && nc === endC) && ext[nr][nc] !== -1) continue;

          visited.add(key(nr, nc));
          parent[key(nr, nc)] = key(r, c);
          queue.push({ r: nr, c: nc });
        }
      }
      return null;
    }

    function initGame() {
      currentLevel = 1;
      reshuffleCount = 2;
      document.getElementById("reshuffle-count").textContent = reshuffleCount;
      document.getElementById("reshuffle-btn").disabled = false;
      setupLevel(currentLevel);
    }

    function nextLevel() {
      if (currentLevel < 5) {
        currentLevel++;
        setupLevel(currentLevel);
      } else {
        showPopup("🏆 全关通关！<br>你已完成全部 5 关挑战！", "🎉");
      }
    }

    function setupLevel(level) {
      const config = LEVEL_CONFIG[level - 1];
      ROWS = config[0];
      COLS = config[1];
      const numTypes = config[2];

      document.getElementById("current-level").textContent = level;
      const total = ROWS * COLS;
      if (total % 2 !== 0) {
        console.error("总图块数必须为偶数！");
        return;
      }

      // 构造成对图块
      const pairs = [];
      for (let i = 0; i < total / 2; i++) {
        pairs.push(i % numTypes);
        pairs.push(i % numTypes);
      }

      // 打乱
      for (let i = pairs.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
      }

      // 初始化 board
      board = Array(ROWS).fill().map(() => Array(COLS).fill(-1));
      totalTiles = total;
      document.getElementById("score").textContent = `剩余图块: ${totalTiles}`;

      const gameBoard = document.getElementById("game-board");
      gameBoard.innerHTML = "";
      gameBoard.style.gridTemplateColumns = `repeat(${COLS}, ${CELL_SIZE}px)`;
      gameBoard.style.gridGap = "2px";

      let idx = 0;
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          board[r][c] = pairs[idx++];
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.style.width = `${CELL_SIZE}px`;
          cell.style.height = `${CELL_SIZE}px`;
          cell.dataset.row = r;
          cell.dataset.col = c;
          const img = document.createElement("img");
          img.src = images[board[r][c]];
          img.onerror = () => img.src = "https://via.placeholder.com/" + CELL_SIZE + "?text=?";
          cell.appendChild(img);
          cell.addEventListener("click", () => handleCellClick(r, c));
          gameBoard.appendChild(cell);
        }
      }

      // 调整 canvas 尺寸
      const containerRect = gameBoard.getBoundingClientRect();
      const canvas = document.getElementById("path-canvas");
      canvas.width = containerRect.width + 40;
      canvas.height = containerRect.height + 40;

      firstSelected = null;
    }

    function reshuffleBoard() {
      if (reshuffleCount <= 0) return;
      reshuffleCount--;
      document.getElementById("reshuffle-count").textContent = reshuffleCount;
      if (reshuffleCount === 0) {
        document.getElementById("reshuffle-btn").disabled = true;
      }

      // 收集所有非空图块
      const tiles = [];
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (board[r][c] !== -1) {
            tiles.push(board[r][c]);
          }
        }
      }

      // 打乱
      for (let i = tiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
      }

      // 重新填回
      let idx = 0;
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (board[r][c] !== -1) {
            board[r][c] = tiles[idx++];
          }
        }
      }

      // 更新 DOM
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (board[r][c] !== -1) {
            const cell = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
            cell.innerHTML = '';
            const img = document.createElement("img");
            img.src = images[board[r][c]];
            img.onerror = () => img.src = "https://via.placeholder.com/" + CELL_SIZE + "?text=?";
            cell.appendChild(img);
          }
        }
      }

      resetSelection();
      showPopup("🎴 牌已重洗！", "🔄");
    }

    function handleCellClick(row, col) {
      if (board[row][col] === -1) return;

      const cell = document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`);
      if (!firstSelected) {
        firstSelected = { row, col };
        cell.classList.add("selected");
      } else {
        if (firstSelected.row === row && firstSelected.col === col) {
          cell.classList.remove("selected");
          firstSelected = null;
          return;
        }

        if (board[firstSelected.row][firstSelected.col] !== board[row][col]) {
          showPopup("❌ 图标不同！", "⚠️");
          resetSelection();
          return;
        }

        const path = findPathBFS(firstSelected.row, firstSelected.col, row, col);

        if (path) {
          const r1 = firstSelected.row, c1 = firstSelected.col;
          const r2 = row, c2 = col;

          const cell1 = document.querySelector(`.cell[data-row="${r1}"][data-col="${c1}"]`);
          const cell2 = document.querySelector(`.cell[data-row="${r2}"][data-col="${c2}"]`);
          cell1.classList.add("removing");
          cell2.classList.add("removing");

          setTimeout(() => {
            cell1.innerHTML = '';
            cell2.innerHTML = '';
            board[r1][c1] = -1;
            board[r2][c2] = -1;
            totalTiles -= 2;
            document.getElementById("score").textContent = `剩余图块: ${totalTiles}`;
          }, 500);

          drawPathOnCanvas(path, () => {
            if (totalTiles === 0) {
              setTimeout(() => {
                if (currentLevel < 5) {
                  showPopup(`✅ 第 ${currentLevel} 关完成！<br>即将进入第 ${currentLevel + 1} 关...`, "🎉");
                  setTimeout(nextLevel, 1500);
                } else {
                  showPopup("🎉 恭喜完成第 5 关！", "🏆");
                }
              }, 300);
            }
          });

        } else {
          showPopup("❌ 无法连接！<br>必须存在一条通过空白格的中心路径！", "⚠️");
        }
        resetSelection();
      }
    }

    function drawPathOnCanvas(path, onComplete) {
      const canvas = document.getElementById("path-canvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const points = path.map(p => ({
        x: p.c * (CELL_SIZE + 2) + CELL_SIZE / 2 + 20,
        y: p.r * (CELL_SIZE + 2) + CELL_SIZE / 2 + 20
      }));

      ctx.strokeStyle = "#ff3b30";
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length; i++) {
        ctx.lineTo(points[i].x, points[i].y);
      }
      ctx.stroke();

      setTimeout(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (onComplete) onComplete();
      }, 700);
    }

    function resetSelection() {
      if (firstSelected) {
        document.querySelector(`.cell[data-row="${firstSelected.row}"][data-col="${firstSelected.col}"]`)
          ?.classList.remove("selected");
        firstSelected = null;
      }
    }

    function showPopup(message, icon = "ℹ️") {
      document.getElementById("popup-icon").textContent = icon;
      document.getElementById("popup-message").innerHTML = message.replace(/\n/g, "<br>");
      document.getElementById("popup").style.display = "flex";
    }

    function closePopup() {
      document.getElementById("popup").style.display = "none";
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closePopup();
    });

    window.onload = initGame;
  </script>
</body>
</html>