<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>勇者传说 - 100关挑战</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(125deg, #0b0f19, #131c2b, #1a2a40);
      color: white;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
      padding: 10px;
      touch-action: none;
    }

    #gameContainer {
      position: relative;
      width: min(95vw, 640px);
      height: min(95vw * 0.75, 480px);
      max-width: 640px;
      max-height: 480px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow:
        0 12px 30px rgba(0, 0, 0, 0.6),
        inset 0 0 0 1px rgba(100, 150, 255, 0.15);
      backdrop-filter: blur(2px);
    }

    #gameCanvas {
      background: #0d1b2a;
      image-rendering: pixelated;
      display: block;
      width: 100%;
      height: 100%;
    }

    #titleBar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      padding: 12px 0;
      text-align: center;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(6px);
      font-size: 20px;
      font-weight: bold;
      letter-spacing: 2px;
      color: #64b5f6;
      z-index: 11;
      border-bottom: 1px solid rgba(100, 181, 246, 0.2);
    }

    #uiPanel {
      position: absolute;
      top: 42px;
      left: 12px;
      background: rgba(15, 23, 42, 0.75);
      padding: 12px 16px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(100, 150, 255, 0.25);
      font-size: 15px;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #uiPanel span {
      font-weight: bold;
      color: #4fc3f7;
    }

    #skillPanel {
      position: absolute;
      bottom: 12px;
      left: 12px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .skill {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(20, 30, 50, 0.8);
      border: 2px solid #4fc3f7;
      color: white;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }

    .skill:hover {
      transform: scale(1.05);
      border-color: #81d4fa;
    }

    .skill.cooldown {
      opacity: 0.5;
      border-color: #555;
      background: rgba(30, 40, 60, 0.8);
    }

    .skill-key {
      font-size: 16px;
      margin-bottom: 2px;
    }

    #message {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      font-size: 24px;
      font-weight: 800;
      text-align: center;
      opacity: 0;
      pointer-events: none;
      z-index: 20;
      text-shadow:
        0 0 8px rgba(255, 255, 255, 0.9),
        0 0 20px gold;
      color: white;
      transition: 
        opacity 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
        transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .show {
      opacity: 1 !important;
      transform: translate(-50%, -50%) scale(1) !important;
    }

    .damage-text {
      position: absolute;
      font-size: 16px;
      font-weight: bold;
      color: #ff5252;
      text-shadow: 0 0 6px rgba(255, 0, 0, 0.8);
      pointer-events: none;
      z-index: 15;
      animation: floatUp 1s forwards;
    }

    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-40px); opacity: 0; }
    }

    #pauseButton {
      position: absolute;
      bottom: 60px;
      left: 12px;
      background-color: rgba(50, 70, 90, 0.8);
      color: white;
      border: none;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      border-radius: 8px;
      z-index: 12;
    }

    #gameInstructions {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background-color: rgba(50, 70, 90, 0.8);
      color: white;
      padding: 12px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      z-index: 10;
      font-size: 13px;
      line-height: 1.4;
      max-width: 220px;
    }

    #instructionsHeader {
      cursor: pointer;
      font-weight: bold;
      color: #64b5f6;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #instructionsContent {
      transition: opacity 0.3s, max-height 0.3s ease-out;
      overflow: hidden;
    }

    #instructionsContent.collapsed {
      opacity: 0;
      max-height: 0 !important;
      padding: 0 !important;
    }

    @media (max-width: 768px) {
      #mobileControls {
        display: block;
        position: absolute;
        bottom: 20px;
        width: 100%;
        pointer-events: none;
      }

      #dPad {
        position: absolute;
        left: 12px;
        bottom: 0;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 6px;
        width: 120px;
        height: 120px;
        pointer-events: auto;
      }

      #dPad button {
        background: rgba(30, 50, 90, 0.7);
        color: white;
        border: 2px solid #4fc3f7;
        border-radius: 8px;
        font-size: 20px;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #btnUp { grid-column: 2; grid-row: 1; }
      #btnLeft { grid-column: 1; grid-row: 2; }
      #btnDown { grid-column: 2; grid-row: 2; }
      #btnRight { grid-column: 3; grid-row: 2; }

      #actionButtons {
        position: absolute;
        right: 12px;
        bottom: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: auto;
      }

      #actionButtons button {
        width: 50px;
        height: 50px;
        background: rgba(30, 50, 90, 0.7);
        color: white;
        border: 2px solid #ff5252;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        user-select: none;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #btnQ, #btnE, #btnR {
        border-color: #4fc3f7;
      }

      .skill div:nth-child(2) {
        display: none;
      }

      #uiPanel {
        font-size: 12px;
        padding: 8px 10px;
      }

      #pauseButton {
        bottom: 140px;
        left: 12px;
        padding: 6px 10px;
        font-size: 14px;
      }

      #gameInstructions {
        max-width: 180px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <div id="titleBar">⚔️ 勇者传说 - 100关挑战</div>
    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <div id="uiPanel">
      ❤️ <span id="hp">100</span> / <span id="maxHp">100</span> |
      ⚔️ <span id="atk">5</span> |
      📊 Lv.<span id="level">1</span> |
      EXP: <span id="exp">0</span>/<span id="expNeeded">3</span> |
      关卡: <span id="stage">1</span>
    </div>
    <div id="skillPanel">
      <div class="skill" id="skillQ">
        <div class="skill-key">Q</div>
        <div>爆炸</div>
      </div>
      <div class="skill" id="skillE">
        <div class="skill-key">E</div>
        <div>护盾</div>
      </div>
      <div class="skill" id="skillR">
        <div class="skill-key">R</div>
        <div>闪电</div>
      </div>
    </div>
    <div id="message">勇者传说</div>

    <button id="pauseButton" onclick="togglePause()">|| 暂停</button>

    <div id="gameInstructions">
      <div id="instructionsHeader" onclick="toggleInstructions()">
        游戏说明
        <span id="toggleIcon">▼</span>
      </div>
      <div id="instructionsContent">
        <p>使用 WASD 或方向键移动。</p>
        <p>空格键进行普通攻击。</p>
        <p>Q：爆炸（范围伤害）</p>
        <p>E：护盾（2秒无敌）</p>
        <p>R：闪电（连锁打击最多5个敌人）</p>
        <p>击败所有敌人即可进入下一关！</p>
      </div>
    </div>

    <div id="mobileControls">
      <div id="dPad">
        <button id="btnUp">↑</button>
        <button id="btnLeft">←</button>
        <button id="btnDown">↓</button>
        <button id="btnRight">→</button>
      </div>
      <div id="actionButtons">
        <button id="btnAttack">⚔️</button>
        <button id="btnQ">Q</button>
        <button id="btnE">E</button>
        <button id="btnR">R</button>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // 全局状态
    let keys = {};
    let enemies = [];
    let damageTexts = [];
    let player = {
      x: 320,
      y: 240,
      size: 20,
      speed: 3,
      hp: 100,
      maxHp: 100,
      atk: 5,
      level: 1,
      exp: 0,
      expNeeded: 3,
      attackCooldown: 0,
      flash: 0,
      shield: 0,
      invincible: false
    };

    let currentStage = 1;
    let gameOver = false;
    let gameWon = false;
    let paused = false;
    let spawnIntervalId = null;

    // 初始化输入监听
    function setupInput() {
      window.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
        if (e.key === ' ') {
          e.preventDefault();
          if (player.attackCooldown <= 0 && !gameOver && !gameWon && !paused) {
            player.attackCooldown = 20;
            player.flash = 5;
            attack();
          }
        }
        if (e.key.toLowerCase() === 'q') useSkill('q');
        if (e.key.toLowerCase() === 'e') useSkill('e');
        if (e.key.toLowerCase() === 'r') useSkill('r');
      });

      window.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
      });
    }

    // 技能按钮绑定
    function setupSkillButtons() {
      document.getElementById('skillQ').addEventListener('click', () => useSkill('q'));
      document.getElementById('skillE').addEventListener('click', () => useSkill('e'));
      document.getElementById('skillR').addEventListener('click', () => useSkill('r'));
    }

    // 移动端虚拟按键
    function setupMobileControls() {
      if (window.innerWidth > 768) return;

      const btnUp = document.getElementById('btnUp');
      const btnDown = document.getElementById('btnDown');
      const btnLeft = document.getElementById('btnLeft');
      const btnRight = document.getElementById('btnRight');
      const btnAttack = document.getElementById('btnAttack');
      const btnQ = document.getElementById('btnQ');
      const btnE = document.getElementById('btnE');
      const btnR = document.getElementById('btnR');

      function bindTouch(el, key) {
        let isPressed = false;
        el.addEventListener('touchstart', (e) => {
          e.preventDefault();
          if (!isPressed) {
            keys[key] = true;
            isPressed = true;
          }
        });
        el.addEventListener('touchend', () => {
          keys[key] = false;
          isPressed = false;
        });
        el.addEventListener('mousedown', () => keys[key] = true);
        el.addEventListener('mouseup', () => keys[key] = false);
        el.addEventListener('mouseleave', () => keys[key] = false);
      }

      bindTouch(btnUp, 'w');
      bindTouch(btnDown, 's');
      bindTouch(btnLeft, 'a');
      bindTouch(btnRight, 'd');

      btnAttack.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (player.attackCooldown <= 0 && !gameOver && !gameWon && !paused) {
          player.attackCooldown = 20;
          player.flash = 5;
          attack();
        }
      });

      btnQ.addEventListener('touchstart', (e) => { e.preventDefault(); useSkill('q'); });
      btnE.addEventListener('touchstart', (e) => { e.preventDefault(); useSkill('e'); });
      btnR.addEventListener('touchstart', (e) => { e.preventDefault(); useSkill('r'); });
    }

    // 普通攻击
    function attack() {
      for (let enemy of enemies) {
        const dx = player.x - enemy.x;
        const dy = player.y - enemy.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 60) {
          enemy.hp -= player.atk;
          createDamageText(enemy.x, enemy.y, player.atk);
          if (enemy.hp <= 0) {
            killEnemy(enemy);
          }
        }
      }
    }

    // 使用技能
    function useSkill(skill) {
      if (paused || gameOver || gameWon) return;

      const now = Date.now();
      if (skill === 'q' && (player.lastQ === undefined || now - player.lastQ > 5000)) {
        player.lastQ = now;
        document.getElementById('skillQ').classList.add('cooldown');
        setTimeout(() => document.getElementById('skillQ').classList.remove('cooldown'), 5000);

        // 爆炸：对周围敌人造成 20 伤害
        for (let enemy of enemies) {
          const dx = player.x - enemy.x;
          const dy = player.y - enemy.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 100) {
            enemy.hp -= 20;
            createDamageText(enemy.x, enemy.y, 20);
            if (enemy.hp <= 0) {
              killEnemy(enemy);
            }
          }
        }
      }

      if (skill === 'e' && (player.lastE === undefined || now - player.lastE > 8000)) {
        player.lastE = now;
        document.getElementById('skillE').classList.add('cooldown');
        setTimeout(() => document.getElementById('skillE').classList.remove('cooldown'), 8000);

        // 护盾：2秒无敌
        player.shield = 120; // 2秒 @ 60fps
        player.invincible = true;
        setTimeout(() => {
          player.invincible = false;
        }, 2000);
      }

      if (skill === 'r' && (player.lastR === undefined || now - player.lastR > 10000)) {
        player.lastR = now;
        document.getElementById('skillR').classList.add('cooldown');
        setTimeout(() => document.getElementById('skillR').classList.remove('cooldown'), 10000);

        // 闪电：最多连锁5个敌人，每个造成 15 伤害
        let targets = [...enemies].sort((a, b) => {
          const da = (a.x - player.x) ** 2 + (a.y - player.y) ** 2;
          const db = (b.x - player.x) ** 2 + (b.y - player.y) ** 2;
          return da - db;
        }).slice(0, 5);

        for (let enemy of targets) {
          enemy.hp -= 15;
          createDamageText(enemy.x, enemy.y, 15);
          if (enemy.hp <= 0) {
            killEnemy(enemy);
          }
        }
      }
    }

    // 创建伤害数字
    function createDamageText(x, y, amount) {
      damageTexts.push({
        x: x,
        y: y,
        text: amount.toString(),
        life: 60
      });
    }

    // 击杀敌人
    function killEnemy(enemy) {
      const index = enemies.indexOf(enemy);
      if (index !== -1) enemies.splice(index, 1);
      player.exp += 1;
      checkLevelUp();
      checkStageClear();
    }

    // 升级检查
    function checkLevelUp() {
      if (player.exp >= player.expNeeded) {
        player.level++;
        player.exp -= player.expNeeded;
        player.expNeeded = Math.floor(player.expNeeded * 1.5);
        player.maxHp += 10;
        player.hp = player.maxHp;
        player.atk += 2;
        updateUI();
        showMessage(`升级！Lv.${player.level}`, true);
      }
    }

    // 关卡完成检查
    function checkStageClear() {
      if (enemies.length === 0 && !gameWon) {
        if (currentStage >= 100) {
          gameWon = true;
          showMessage("🎉 通关成功！你完成了100关！", true);
          clearInterval(spawnIntervalId);
          return;
        }
        currentStage++;
        startStage(currentStage);
        showMessage(`第 ${currentStage} 关`, true);
      }
    }

    // 开始新关卡
    function startStage(stage) {
      enemies = [];
      const count = Math.min(5 + Math.floor(stage / 5), 20);
      for (let i = 0; i < count; i++) {
        let x, y;
        do {
          x = Math.random() * (canvas.width - 40) + 20;
          y = Math.random() * (canvas.height - 40) + 20;
        } while (Math.hypot(x - player.x, y - player.y) < 100);
        enemies.push({
          x: x,
          y: y,
          size: 15 + Math.random() * 10,
          hp: 10 + Math.floor(stage / 3),
          maxHp: 10 + Math.floor(stage / 3),
          speed: 0.5 + Math.random() * 0.5,
          color: `hsl(${200 + stage * 2 % 360}, 70%, 60%)`
        });
      }
      updateUI();
    }

    // 随机刷怪（用于测试）
    function spawnRandomMinions() {
      if (enemies.length < 30 && !gameOver && !gameWon && !paused) {
        let x = Math.random() < 0.5 ? -20 : canvas.width + 20;
        let y = Math.random() * canvas.height;
        enemies.push({
          x: x,
          y: y,
          size: 15,
          hp: 10,
          maxHp: 10,
          speed: 1,
          color: '#f44336'
        });
      }
    }

    // 更新UI
    function updateUI() {
      document.getElementById('hp').textContent = player.hp;
      document.getElementById('maxHp').textContent = player.maxHp;
      document.getElementById('atk').textContent = player.atk;
      document.getElementById('level').textContent = player.level;
      document.getElementById('exp').textContent = player.exp;
      document.getElementById('expNeeded').textContent = player.expNeeded;
      document.getElementById('stage').textContent = currentStage;
    }

    // 显示消息
    function showMessage(text, permanent = false) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.classList.add('show');
      if (!permanent) {
        setTimeout(() => hideMessage(), 2000);
      }
    }

    function hideMessage() {
      document.getElementById('message').classList.remove('show');
    }

    // 暂停切换
    function togglePause() {
      paused = !paused;
      document.getElementById('pauseButton').textContent = paused ? '▶ 继续' : '|| 暂停';
      if (!paused) {
        gameLoop();
      }
    }

    // 切换说明
    function toggleInstructions() {
      const content = document.getElementById('instructionsContent');
      const icon = document.getElementById('toggleIcon');
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.textContent = '▲';
      } else {
        content.classList.add('collapsed');
        icon.textContent = '▼';
      }
    }

    // 移动玩家
    function movePlayer() {
      let dx = 0, dy = 0;
      if (keys['w'] || keys['arrowup']) dy -= player.speed;
      if (keys['s'] || keys['arrowdown']) dy += player.speed;
      if (keys['a'] || keys['arrowleft']) dx -= player.speed;
      if (keys['d'] || keys['arrowright']) dx += player.speed;

      if (dx !== 0 && dy !== 0) {
        dx *= 0.7071;
        dy *= 0.7071;
      }

      player.x += dx;
      player.y += dy;

      player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
      player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
    }

    // 敌人AI
    function updateEnemies() {
      for (let enemy of enemies) {
        const dx = player.x - enemy.x;
        const dy = player.y - enemy.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist > 0) {
          enemy.x += (dx / dist) * enemy.speed;
          enemy.y += (dy / dist) * enemy.speed;
        }

        // 碰撞检测
        if (dist < player.size + enemy.size && !player.invincible) {
          player.hp -= 0.5;
          if (player.hp <= 0) {
            player.hp = 0;
            gameOver = true;
            showMessage("💀 游戏结束", true);
            clearInterval(spawnIntervalId);
          }
        }
      }
    }

    // 更新伤害数字
    function updateDamageTexts() {
      for (let i = damageTexts.length - 1; i >= 0; i--) {
        damageTexts[i].life--;
        damageTexts[i].y -= 1;
        if (damageTexts[i].life <= 0) {
          damageTexts.splice(i, 1);
        }
      }
    }

    // 渲染
    function render() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 绘制玩家
      if (player.flash > 0) {
        ctx.fillStyle = '#ffffff';
        player.flash--;
      } else {
        ctx.fillStyle = player.shield > 0 ? '#4fc3f7' : '#4caf50';
      }
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
      ctx.fill();

      if (player.shield > 0) {
        ctx.strokeStyle = '#81d4fa';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size + 8, 0, Math.PI * 2);
        ctx.stroke();
        player.shield--;
      }

      // 绘制敌人
      for (let enemy of enemies) {
        ctx.fillStyle = enemy.color;
        ctx.beginPath();
        ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
        ctx.fill();

        // 血条
        const barWidth = enemy.size * 2;
        const ratio = enemy.hp / enemy.maxHp;
        ctx.fillStyle = '#333';
        ctx.fillRect(enemy.x - barWidth / 2, enemy.y - enemy.size - 10, barWidth, 4);
        ctx.fillStyle = ratio > 0.5 ? '#4caf50' : ratio > 0.25 ? '#ff9800' : '#f44336';
        ctx.fillRect(enemy.x - barWidth / 2, enemy.y - enemy.size - 10, barWidth * ratio, 4);
      }

      // 绘制伤害数字
      ctx.fillStyle = '#ff5252';
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'center';
      for (let dt of damageTexts) {
        ctx.fillText(dt.text, dt.x, dt.y);
      }
    }

    // 主循环
    function gameLoop() {
      if (paused || gameOver || gameWon) return;

      movePlayer();
      if (player.attackCooldown > 0) player.attackCooldown--;
      updateEnemies();
      updateDamageTexts();
      render();

      requestAnimationFrame(gameLoop);
    }

    // 启动游戏
    function init() {
      startStage(1);
      setupInput();
      setupSkillButtons();
      setupMobileControls();
      gameLoop();
      showMessage("勇者传说 - 100关挑战", true);
      setTimeout(() => hideMessage(), 2500);

      spawnIntervalId = setInterval(spawnRandomMinions, 2000);
    }

    window.onload = init;
  </script>
</body>
</html>